"use strict";function getType(e){return Buffer.isBuffer(e)?"buffer":Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}var util=require("../"),fs=require("fs"),path=require("path"),Tempfile=require("temporary/lib/file");exports["util.callbackify"]={"return":function(e){function t(e,t){return e+t}e.expect(1);util.callbackify(t)(1,2,function(t){e.equal(t,3,"should be the correct result.");e.done()})},"callback (sync)":function(e){function t(e,t,n){n(e+t)}e.expect(1);util.callbackify(t)(1,2,function(t){e.equal(t,3,"should be the correct result.");e.done()})},"callback (async)":function(e){function t(e,t,n){setTimeout(n.bind(null,e+t),0)}e.expect(1);util.callbackify(t)(1,2,function(t){e.equal(t,3,"should be the correct result.");e.done()})}};exports.util={error:function(e){e.expect(9);var t=new Error("Original error."),n=util.error("Test message.");e.ok(n instanceof Error,"Should be an Error.");e.equal(n.name,"Error","Should be an Error.");e.equal(n.message,"Test message.","Should have the correct message.");n=util.error("Test message.",t);e.ok(n instanceof Error,"Should be an Error.");e.equal(n.name,"Error","Should be an Error.");e.equal(n.message,"Test message.","Should have the correct message.");e.equal(n.origError,t,"Should reflect the original error.");var r=new Error("Test message.");n=util.error(r,t);e.equal(n,r,"Should be the passed-in Error.");e.equal(n.origError,t,"Should reflect the original error.");e.done()},linefeed:function(e){e.expect(1);process.platform==="win32"?e.equal(util.linefeed,"\r\n","linefeed should be operating-system appropriate."):e.equal(util.linefeed,"\n","linefeed should be operating-system appropriate.");e.done()},normalizelf:function(e){e.expect(1);process.platform==="win32"?e.equal(util.normalizelf("foo\nbar\r\nbaz\r\n\r\nqux\n\nquux"),"foo\r\nbar\r\nbaz\r\n\r\nqux\r\n\r\nquux","linefeeds should be normalized"):e.equal(util.normalizelf("foo\nbar\r\nbaz\r\n\r\nqux\n\nquux"),"foo\nbar\nbaz\n\nqux\n\nquux","linefeeds should be normalized");e.done()}};exports["util.spawn"]={setUp:function(e){this.script=path.resolve("test/fixtures/spawn.js");e()},"exit code 0":function(e){e.expect(6);util.spawn({cmd:process.execPath,args:[this.script,0]},function(t,n,r){e.equals(t,null);e.equals(r,0);e.equals(n.stdout,"stdout");e.equals(n.stderr,"stderr");e.equals(n.code,0);e.equals(String(n),"stdout");e.done()})},"exit code 0, fallback":function(e){e.expect(6);util.spawn({cmd:process.execPath,args:[this.script,0],fallback:"ignored if exit code is 0"},function(t,n,r){e.equals(t,null);e.equals(r,0);e.equals(n.stdout,"stdout");e.equals(n.stderr,"stderr");e.equals(n.code,0);e.equals(String(n),"stdout");e.done()})},"non-zero exit code":function(e){e.expect(7);util.spawn({cmd:process.execPath,args:[this.script,123]},function(t,n,r){e.ok(t instanceof Error);e.equals(t.message,"stderr");e.equals(r,123);e.equals(n.stdout,"stdout");e.equals(n.stderr,"stderr");e.equals(n.code,123);e.equals(String(n),"stderr");e.done()})},"non-zero exit code, fallback":function(e){e.expect(6);util.spawn({cmd:process.execPath,args:[this.script,123],fallback:"custom fallback"},function(t,n,r){e.equals(t,null);e.equals(r,123);e.equals(n.stdout,"stdout");e.equals(n.stderr,"stderr");e.equals(n.code,123);e.equals(String(n),"custom fallback");e.done()})},"cmd not found":function(e){e.expect(3);util.spawn({cmd:"nodewtfmisspelled"},function(t,n,r){e.ok(t instanceof Error);e.equals(r,127);e.equals(n.code,127);e.done()})},"cmd not found, fallback":function(e){e.expect(4);util.spawn({cmd:"nodewtfmisspelled",fallback:"use a fallback or good luck"},function(t,n,r){e.equals(t,null);e.equals(r,127);e.equals(n.code,127);e.equals(String(n),"use a fallback or good luck");e.done()})},"cmd not in path":function(e){e.expect(6);var t=process.platform==="win32";util.spawn({cmd:"test\\fixtures\\exec"+(t?".cmd":".sh")},function(t,n,r){e.equals(t,null);e.equals(r,0);e.equals(n.stdout,"done");e.equals(n.stderr,"");e.equals(n.code,0);e.equals(String(n),"done");e.done()})},"cmd not in path (with cwd)":function(e){e.expect(6);var t=process.platform==="win32";util.spawn({cmd:"./exec"+(t?".cmd":".sh"),opts:{cwd:"test/fixtures"}},function(t,n,r){e.equals(t,null);e.equals(r,0);e.equals(n.stdout,"done");e.equals(n.stderr,"");e.equals(n.code,0);e.equals(String(n),"done");e.done()})},grunt:function(e){e.expect(3);util.spawn({grunt:!0,args:["--gruntfile","test/fixtures/Gruntfile-print-text.js","print:foo"]},function(t,n,r){e.equals(t,null);e.equals(r,0);e.ok(/^OUTPUT: foo/m.test(n.stdout),"stdout should contain output indicating the grunt task was run.");e.done()})},"grunt (with cwd)":function(e){e.expect(3);util.spawn({grunt:!0,args:["--gruntfile","Gruntfile-print-text.js","print:foo"],opts:{cwd:"test/fixtures"}},function(t,n,r){e.equals(t,null);e.equals(r,0);e.ok(/^OUTPUT: foo/m.test(n.stdout),"stdout should contain output indicating the grunt task was run.");e.done()})},"grunt passes execArgv":function(e){e.expect(3);util.spawn({cmd:process.execPath,args:["--harmony",process.argv[1],"--gruntfile","test/fixtures/Gruntfile-execArgv.js"]},function(t,n,r){e.equals(t,null);e.equals(r,0);e.ok(/^OUTPUT: --harmony/m.test(n.stdout),"stdout should contain passed-through process.execArgv.");e.done()})},"grunt result.toString() with error":function(e){e.expect(4);util.spawn({grunt:!0,args:["nonexistentTask"]},function(t,n,r){e.ok(t instanceof Error,"Should be an Error.");e.equal(t.name,"Error","Should be an Error.");e.equals(r,3);e.ok(/Warning: Task "nonexistentTask" not found./m.test(n.toString()),"stdout should contain output indicating the grunt task was (attempted to be) run.");e.done()})},"custom stdio stream(s)":function(e){e.expect(6);var t=new Tempfile,n=new Tempfile,r=fs.openSync(t.path,"a"),i=fs.openSync(n.path,"a"),s=util.spawn({cmd:process.execPath,args:[this.script,0],opts:{stdio:[null,r,i]}},function(r,i,s){e.equals(s,0);e.equals(String(fs.readFileSync(t.path)),"stdout\n","Child process stdout should have been captured via custom stream.");e.equals(String(fs.readFileSync(n.path)),"stderr\n","Child process stderr should have been captured via custom stream.");t.unlinkSync();n.unlinkSync();e.equals(i.stdout,"","Nothing will be passed to the stdout string when spawn stdio is a custom stream.");e.done()});e.ok(!s.stdout,"child should not have a stdout property.");e.ok(!s.stderr,"child should not have a stderr property.")}};exports["util.spawn.multibyte"]={setUp:function(e){this.script=path.resolve("test/fixtures/spawn-multibyte.js");e()},"partial stdout":function(e){e.expect(4);util.spawn({cmd:process.execPath,args:[this.script]},function(t,n,r){e.equals(t,null);e.equals(r,0);e.equals(n.stdout,"こんにちは");e.equals(n.stderr,"こんにちは");e.done()})}};exports["util.underscore.string"]=function(e){e.expect(4);e.equals(util._.trim("    foo     "),"foo","Should have trimmed the string.");e.equals(util._.capitalize("foo"),"Foo","Should have capitalized the first letter.");e.equals(util._.words("one two three").length,3,"Should have counted three words.");e.ok(util._.isBlank(" "),"Should be blank.");e.done()};exports["util.recurse"]={setUp:function(e){this.typeValue=function(e){return{value:e,type:getType(e)}};e()},primitives:function(e){e.expect(1);var t=util.recurse({bool:!0,num:1,str:"foo",nul:null,undef:undefined},this.typeValue),n={bool:{type:"boolean",value:!0},num:{type:"number",value:1},str:{type:"string",value:"foo"},nul:{type:"null",value:null},undef:{type:"undefined",value:undefined}};e.deepEqual(t,n,"Should process primitive values.");e.done()},array:function(e){e.expect(1);var t=util.recurse({arr:[!0,1,"foo",null,undefined,[!0,1,"foo",null,undefined]]},this.typeValue),n={arr:[{type:"boolean",value:!0},{type:"number",value:1},{type:"string",value:"foo"},{type:"null",value:null},{type:"undefined",value:undefined},[{type:"boolean",value:!0},{type:"number",value:1},{type:"string",value:"foo"},{type:"null",value:null},{type:"undefined",value:undefined}]]};e.deepEqual(t,n,"Should recurse over arrays.");e.done()},object:function(e){e.expect(1);var t=util.recurse({obj:{bool:!0,num:1,str:"foo",nul:null,undef:undefined,obj:{bool:!0,num:1,str:"foo",nul:null,undef:undefined}}},this.typeValue),n={obj:{bool:{type:"boolean",value:!0},num:{type:"number",value:1},str:{type:"string",value:"foo"},nul:{type:"null",value:null},undef:{type:"undefined",value:undefined},obj:{bool:{type:"boolean",value:!0},num:{type:"number",value:1},str:{type:"string",value:"foo"},nul:{type:"null",value:null},undef:{type:"undefined",value:undefined}}}};e.deepEqual(t,n,"Should recurse over objects.");e.done()},"array in object":function(e){e.expect(1);var t=util.recurse({obj:{arr:[!0,1,"foo",null,undefined]}},this.typeValue),n={obj:{arr:[{type:"boolean",value:!0},{type:"number",value:1},{type:"string",value:"foo"},{type:"null",value:null},{type:"undefined",value:undefined}]}};e.deepEqual(t,n,"Should recurse over arrays in objects.");e.done()},"object in array":function(e){e.expect(1);var t=util.recurse({arr:[!0,{num:1,str:"foo"},null,undefined]},this.typeValue),n={arr:[{type:"boolean",value:!0},{num:{type:"number",value:1},str:{type:"string",value:"foo"}},{type:"null",value:null},{type:"undefined",value:undefined}]};e.deepEqual(t,n,"Should recurse over objects in arrays.");e.done()},buffer:function(e){e.expect(1);var t=util.recurse({buf:new Buffer("buf")},this.typeValue),n={buf:{type:"buffer",value:new Buffer("buf")}};e.deepEqual(t,n,"Should not mangle Buffer instances.");e.done()},"inherited properties":function(e){e.expect(1);var t=util.recurse({obj:Object.create({num:1},{str:{value:"foo",enumerable:!0},ignored:{value:"ignored",enumerable:!1}})},this.typeValue),n={obj:{num:{type:"number",value:1},str:{type:"string",value:"foo"}}};e.deepEqual(t,n,"Should enumerate inherited object properties.");e.done()},"circular references":function(e){function t(e){return function(t){return t.path===e&&t.message==="Circular reference detected ("+e+")"}}e.expect(6);e.doesNotThrow(function(){var e={a:[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[[]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]],b:[[[[],[[[],[[[[],[[[],[[[],[[[],[[[],[[[[],[[]]]]]]]]]]]]]]]]]]]]],c:{d:{e:{f:{g:{h:{i:{j:{k:{l:{m:{n:{o:{p:{q:{r:{s:{}}}}}}}}}}}}}}}}},t:[{u:[{v:[[[[],[[[],[[[{w:[{x:[[[],[[[{y:[[1]]}]]]]]}]}]]]]]]]]}]}]};util.recurse(e,function(e){return e})},"Should not throw when no circular reference is detected.");e.throws(function(){var e={a:1,b:2};e.obj=e;util.recurse(e,function(e){return e})},t(".obj"),"Should throw when a circular reference is detected.");e.throws(function(){var e={a:{"b b":{"c-c":{d_d:{e:{f:{g:{h:{i:{j:{k:{l:{}}}}}}}}}}}}};e.a["b b"]["c-c"].d_d.e.f.g.h.i.j.k.l.obj=e;util.recurse(e,function(e){return e})},t('.a["b b"]["c-c"].d_d.e.f.g.h.i.j.k.l.obj'),"Should throw when a circular reference is detected.");e.throws(function(){var e={a:1,b:2};e.arr=[1,2,e,3,4];util.recurse(e,function(e){return e})},t(".arr[2]"),"Should throw when a circular reference is detected.");e.throws(function(){var e={a:1,b:2};e.arr=[{a:[1,{b:[2,{c:[3,e,4]},5]},6]},7];util.recurse(e,function(e){return e})},t(".arr[0].a[1].b[1].c[1]"),"Should throw when a circular reference is detected.");e.throws(function(){var e={a:1,b:2};e.arr=[];e.arr.push(0,{a:[1,{b:[2,{c:[3,e.arr,4]},5]},6]},7);util.recurse(e,function(e){return e})},t(".arr[1].a[1].b[1].c[1]"),"Should throw when a circular reference is detected.");e.done()}};