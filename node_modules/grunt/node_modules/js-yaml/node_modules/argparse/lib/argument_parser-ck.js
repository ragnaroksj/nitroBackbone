/**
 * class ArgumentParser
 *
 * Object for parsing command line strings into js objects.
 *
 * Inherited from [[ActionContainer]]
 **/"use strict";var util=require("util"),format=require("util").format,Path=require("path"),_=require("underscore");_.str=require("underscore.string");var $$=require("./const"),ActionContainer=require("./action_container"),argumentErrorHelper=require("./argument/error"),HelpFormatter=require("./help/formatter"),Namespace=require("./namespace"),ArgumentParser=module.exports=function(t){var n=this;t=t||{};t.description=t.description||null;t.argumentDefault=t.argumentDefault||null;t.prefixChars=t.prefixChars||"-";t.conflictHandler=t.conflictHandler||"error";ActionContainer.call(this,t);t.addHelp=t.addHelp===undefined||!!t.addHelp;t.parents=t.parents||[];t.prog=t.prog||Path.basename(process.argv[1]);this.prog=t.prog;this.usage=t.usage;this.epilog=t.epilog;this.version=t.version;this.debug=t.debug===!0;this.formatterClass=t.formatterClass||HelpFormatter;this.fromfilePrefixChars=t.fromfilePrefixChars||null;this._positionals=this.addArgumentGroup({title:"Positional arguments"});this._optionals=this.addArgumentGroup({title:"Optional arguments"});this._subparsers=null;var r=function(e){return e};this.register("type","auto",r);this.register("type",null,r);this.register("type","int",function(e){var t=parseInt(e,10);if(isNaN(t))throw new Error(e+" is not a valid integer.");return t});this.register("type","float",function(e){var t=parseFloat(e);if(isNaN(t))throw new Error(e+" is not a valid float.");return t});this.register("type","string",function(e){return""+e});var i=this.prefixChars.indexOf("-")>-1?"-":this.prefixChars[0];t.addHelp&&this.addArgument([i+"h",i+i+"help"],{action:"help",defaultValue:$$.SUPPRESS,help:"Show this help message and exit."});this.version!==undefined&&this.addArgument([i+"v",i+i+"version"],{action:"version",version:this.version,defaultValue:$$.SUPPRESS,help:"Show program's version number and exit."});t.parents.forEach(function(e){n._addContainerActions(e);if(e._defaults!==undefined)for(var t in e._defaults)e._defaults.hasOwnProperty(t)&&(n._defaults[t]=e._defaults[t])})};util.inherits(ArgumentParser,ActionContainer);ArgumentParser.prototype.addSubparsers=function(e){!this._subparsers||this.error("Cannot have multiple subparser arguments.");e=e||{};e.debug=this.debug===!0;e.optionStrings=[];e.parserClass=e.parserClass||ArgumentParser;if(!e.title&&!e.description)this._subparsers=this._positionals;else{this._subparsers=this.addArgumentGroup({title:e.title||"subcommands",description:e.description});delete e.title;delete e.description}if(!e.prog){var t=this._getFormatter(),n=this._getPositionalActions(),r=this._mutuallyExclusiveGroups;t.addUsage(this.usage,n,r,"");e.prog=_.str.strip(t.formatHelp())}var i=this._popActionClass(e,"parsers"),s=new i(e);this._subparsers._addAction(s);return s};ArgumentParser.prototype._addAction=function(e){e.isOptional()?this._optionals._addAction(e):this._positionals._addAction(e);return e};ArgumentParser.prototype._getOptionalActions=function(){return this._actions.filter(function(e){return e.isOptional()})};ArgumentParser.prototype._getPositionalActions=function(){return this._actions.filter(function(e){return e.isPositional()})};ArgumentParser.prototype.parseArgs=function(e,t){var n,r=this.parseKnownArgs(e,t);e=r[0];n=r[1];n&&n.length>0&&this.error(format("Unrecognized arguments: %s.",n.join(" ")));return e};ArgumentParser.prototype.parseKnownArgs=function(e,t){var n=this;e=e||process.argv.slice(2);t=t||new Namespace;n._actions.forEach(function(e){if(e.dest!==$$.SUPPRESS&&!_.has(t,e.dest)&&e.defaultValue!==$$.SUPPRESS){var r=e.defaultValue;_.isString(e.defaultValue)&&(r=n._getValue(e,r));t[e.dest]=r}});_.keys(n._defaults).forEach(function(e){t[e]=n._defaults[e]});try{var r=this._parseKnownArgs(e,t);t=r[0];e=r[1];if(_.has(t,$$._UNRECOGNIZED_ARGS_ATTR)){e=_.union(e,t[$$._UNRECOGNIZED_ARGS_ATTR]);delete t[$$._UNRECOGNIZED_ARGS_ATTR]}return[t,e]}catch(i){this.error(i)}};ArgumentParser.prototype._parseKnownArgs=function(e,t){function i(e){return e.getName()}function p(e,r,s){c.push(e);var o=n._getValues(e,r);if(o!==e.defaultValue){h.push(e);!u[i(e)]||u[i(e)].forEach(function(t){if(h.indexOf(t)>=0)throw argumentErrorHelper(e,format('Not allowed with argument "%s".',t.getName()))})}o!==$$.SUPPRESS&&e.call(n,t,o,s)}function d(t){var i=a[t],s=i[0],o=i[1],u=i[2],f=[],c,h,d,v;for(;;){if(!s){r.push(e[t]);return t+1}if(!u){d=t+1;var E=l.substr(d);h=n._matchArgument(s,E);v=d+h;c=e.slice(d,v);f.push([s,c,o]);break}h=n._matchArgument(s,"A");var m=n.prefixChars;if(!(h===0&&m.indexOf(o[1])<0)){if(h===1){v=t+1;c=[u];f.push([s,c,o]);break}var w="ignored explicit argument %r";throw argumentErrorHelper(s,_.str.sprintf(w,u))}f.push([s,[],o]);o=o[0]+u[0];var g=u.slice(1)||null,y=n._optionStringActions;if(!(_.keys(y).indexOf(o)>=0)){var b="ignored explicit argument %r";throw argumentErrorHelper(s,b)}s=y[o];u=g}if(f.length<1)throw new Error("length should be > 0");for(var S=0;S<f.length;S++)p.apply(n,f[S]);return v}function m(t){var r=l.substr(t),i=n._matchArgumentsPartial(v,r);_.zip(v,i).forEach(function(n){var r=n[0],i=n[1];if(i===undefined)return;var s=e.slice(t,t+i);t+=i;p(r,s)});v=v.slice(i.length);return t}var n=this,r=[];this.fromfilePrefixChars!==null&&(e=this._readArgsFromFiles(e));var s,o,u={};this._mutuallyExclusiveGroups.forEach(function(e){e._groupActions.forEach(function(e,t,n){o=i(e);_.has(u,o)||(u[o]=[]);s=u[o];s.push.apply(s,n.slice(0,t));s.push.apply(s,n.slice(t+1))})});var a={},f=[];e.forEach(function(t,r){if(t==="--"){f.push("-");while(r<e.length){f.push("A");r++}}else{var i,s=n._parseOptional(t);if(!s)i="A";else{a[r]=s;i="O"}f.push(i)}});var l=f.join(""),c=[],h=[],v=n._getPositionalActions(),g=0,y,b=-1;if(!!a)for(y in a)b=Math.max(b,parseInt(y,10));var w,E;while(g<=b){E=null;for(y in a){y=parseInt(y,10);y>=g&&(E!==null?E=Math.min(E,y):E=y)}if(g!==E){w=m(g);if(w>g){g=w;continue}g=w}if(!a[g]){var S=e.slice(g,E);r=r.concat(S);g=E}g=d(g)}var x=m(g);r=r.concat(_.rest(e,x));v.length>0&&n.error("too few arguments");n._actions.forEach(function(e){e.required&&_.indexOf(c,e)<0&&n.error(format('Argument "%s" is required',e.getName()))});var T=!1;n._mutuallyExclusiveGroups.forEach(function(e){if(e.required){T=_.any(e._groupActions,function(e){return _.contains(h,e)});if(!T){var t=[];e._groupActions.forEach(function(e){e.help!==$$.SUPPRESS&&t.push(e.getName())});t=t.join(" ");var r="one of the arguments "+t+" is required";n.error(r)}}});return[t,r]};ArgumentParser.prototype._readArgsFromFiles=function(e){var t=this,n=require("fs"),r=[];e.forEach(function(e){if(t.fromfilePrefixChars.indexOf(e[0])<0)r.push(e);else try{var i=[],s=e.slice(1),o=n.readFileSync(s,"utf8");o=o.trim().split("\n");o.forEach(function(e){t.convertArgLineToArgs(e).forEach(function(e){i.push(e)});i=t._readArgsFromFiles(i)});r.push.apply(r,i)}catch(u){return t.error(u.message)}});return r};ArgumentParser.prototype.convertArgLineToArgs=function(e){return[e]};ArgumentParser.prototype._matchArgument=function(e,t){var n=new RegExp("^"+this._getNargsPattern(e)),r=t.match(n),i;if(!r){switch(e.nargs){case undefined:case null:i="Expected one argument.";break;case $$.OPTIONAL:i="Expected at most one argument.";break;case $$.ONE_OR_MORE:i="Expected at least one argument.";break;default:i="Expected %s argument(s)"}throw argumentErrorHelper(e,format(i,e.nargs))}return r[1].length};ArgumentParser.prototype._matchArgumentsPartial=function(e,t){var n=this,r=[],i,s,o,u,a,f=function(e){return e.length};for(u=e.length;u>0;u-=1){s="";i=e.slice(0,u);for(a in i)s+=n._getNargsPattern(i[a]);s=new RegExp("^"+s);o=t.match(s);if(o&&o.length>0){o=o.splice(1);r=r.concat(o.map(f));break}}return r};ArgumentParser.prototype._parseOptional=function(e){var t,n,r,i;if(!e)return null;if(this.prefixChars.indexOf(e[0])<0)return null;if(!this._optionStringActions[e]){if(e.length===1)return null;if(e.indexOf("=")>=0){var s=e.split("=");n=s[0];r=s[1];if(!!this._optionStringActions[n]){t=this._optionStringActions[n];return[t,n,r]}}i=this._getOptionTuples(e);if(i.length>1){var o=i.map(function(e){return e[1]});this.error(format('Ambiguous option: "%s" could match %s.',e,o.join(", ")))}else if(i.length===1)return i[0];return e.match(this._regexpNegativeNumber)&&!_.any(this._hasNegativeNumberOptionals)?null:e.search(" ")>=0?null:[null,e,null]}return[this._optionStringActions[e],e,null]};ArgumentParser.prototype._getOptionTuples=function(e){var t=[],n=this.prefixChars,r,i,s,o;if(n.indexOf(e[0])>=0&&n.indexOf(e[1])>=0){if(e.indexOf("=")>=0){var u=e.split("=",1);r=u[0];i=u[1]}else{r=e;i=null}for(o in this._optionStringActions)if(o.substr(0,r.length)===r){s=this._optionStringActions[o];t.push([s,o,i])}}else{if(!(n.indexOf(e[0])>=0&&n.indexOf(e[1])<0))throw new Error(format("Unexpected option string: %s.",e));r=e;i=null;var a=e.substr(0,2),f=e.substr(2);for(o in this._optionStringActions){s=this._optionStringActions[o];o===a?t.push([s,o,f]):o.substr(0,r.length)===r&&t.push([s,o,i])}}return t};ArgumentParser.prototype._getNargsPattern=function(e){var t;switch(e.nargs){case undefined:case null:t="(-*A-*)";break;case $$.OPTIONAL:t="(-*A?-*)";break;case $$.ZERO_OR_MORE:t="(-*[A-]*)";break;case $$.ONE_OR_MORE:t="(-*A[A-]*)";break;case $$.REMAINDER:t="([-AO]*)";break;case $$.PARSER:t="(-*A[-AO]*)";break;default:t="(-*"+_.str.repeat("-*A",e.nargs)+"-*)"}if(e.isOptional()){t=t.replace(/-\*/g,"");t=t.replace(/-/g,"")}return t};ArgumentParser.prototype._getValues=function(e,t){var n=this;e.nargs!==$$.PARSER&&e.nargs!==$$.REMAINDER&&(t=t.filter(function(e){return e!=="--"}));var r,i;if(t.length===0&&e.nargs===$$.OPTIONAL){r=e.isOptional()?e.constant:e.defaultValue;if(typeof r=="string"){r=this._getValue(e,r);this._checkValue(e,r)}}else if(t.length===0&&e.nargs===$$.ZERO_OR_MORE&&e.optionStrings.length===0){r=e.defaultValue||t;this._checkValue(e,r)}else if(t.length!==1||!!e.nargs&&e.nargs!==$$.OPTIONAL)if(e.nargs===$$.REMAINDER)r=t.map(function(t){return n._getValue(e,t)});else if(e.nargs===$$.PARSER){r=t.map(function(t){return n._getValue(e,t)});this._checkValue(e,r[0])}else{r=t.map(function(t){return n._getValue(e,t)});r.forEach(function(t){n._checkValue(e,t)})}else{i=t[0];r=this._getValue(e,i);this._checkValue(e,r)}return r};ArgumentParser.prototype._getValue=function(e,t){var n,r=this._registryGet("type",e.type,e.type);if(!_.isFunction(r)){var i=format("%s is not callable",r);throw argumentErrorHelper(e,i)}try{n=r(t)}catch(s){var o=null;_.isString(e.type)?o=e.type:o=e.type.name||e.type.displayName||"<function>";var u=format("Invalid %s value: %s",o,t);o==="<function>"&&(u+="\n"+s.message);throw argumentErrorHelper(e,u)}return n};ArgumentParser.prototype._checkValue=function(e,t){var n=e.choices;if(!!n){if((_.isString(n)||_.isArray(n))&&n.indexOf(t)!==-1)return;if(_.isObject(n)&&!_.isArray(n)&&n[t])return;_.isString(n)?n=n.split("").join(", "):_.isArray(n)?n=n.join(", "):n=_.keys(n).join(", ");var r=format("Invalid choice: %s (choose from [%s])",t,n);throw argumentErrorHelper(e,r)}};ArgumentParser.prototype.formatUsage=function(){var e=this._getFormatter();e.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups);return e.formatHelp()};ArgumentParser.prototype.formatHelp=function(){var e=this._getFormatter();e.addUsage(this.usage,this._actions,this._mutuallyExclusiveGroups);e.addText(this.description);this._actionGroups.forEach(function(t){e.startSection(t.title);e.addText(t.description);e.addArguments(t._groupActions);e.endSection()});e.addText(this.epilog);return e.formatHelp()};ArgumentParser.prototype._getFormatter=function(){var e=this.formatterClass,t=new e({prog:this.prog});return t};ArgumentParser.prototype.printUsage=function(){this._printMessage(this.formatUsage())};ArgumentParser.prototype.printHelp=function(){this._printMessage(this.formatHelp())};ArgumentParser.prototype._printMessage=function(e,t){t||(t=process.stdout);e&&t.write(""+e)};ArgumentParser.prototype.exit=function(e,t){!t||(e===0?this._printMessage(t):this._printMessage(t,process.stderr));process.exit(e)};ArgumentParser.prototype.error=function(e){var t;if(e instanceof Error){if(this.debug===!0)throw e;t=e.message}else t=e;var n=format("%s: error: %s",this.prog,t)+$$.EOL;if(this.debug===!0)throw new Error(n);this.printUsage(process.stderr);return this.exit(2,n)};