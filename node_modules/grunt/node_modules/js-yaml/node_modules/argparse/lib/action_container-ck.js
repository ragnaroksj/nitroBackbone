/** internal
 * class ActionContainer
 *
 * Action container. Parent for [[ArgumentParser]] and [[ArgumentGroup]]
 **/"use strict";var format=require("util").format,_=require("underscore");_.str=require("underscore.string");var $$=require("./const"),ActionHelp=require("./action/help"),ActionAppend=require("./action/append"),ActionAppendConstant=require("./action/append/constant"),ActionCount=require("./action/count"),ActionStore=require("./action/store"),ActionStoreConstant=require("./action/store/constant"),ActionStoreTrue=require("./action/store/true"),ActionStoreFalse=require("./action/store/false"),ActionVersion=require("./action/version"),ActionSubparsers=require("./action/subparsers"),argumentErrorHelper=require("./argument/error"),ActionContainer=module.exports=function(t){t=t||{};this.description=t.description;this.argumentDefault=t.argumentDefault;this.prefixChars=t.prefixChars||"";this.conflictHandler=t.conflictHandler;this._registries={};this.register("action",null,ActionStore);this.register("action","store",ActionStore);this.register("action","storeConst",ActionStoreConstant);this.register("action","storeTrue",ActionStoreTrue);this.register("action","storeFalse",ActionStoreFalse);this.register("action","append",ActionAppend);this.register("action","appendConst",ActionAppendConstant);this.register("action","count",ActionCount);this.register("action","help",ActionHelp);this.register("action","version",ActionVersion);this.register("action","parsers",ActionSubparsers);this._getHandler();this._actions=[];this._optionStringActions={};this._actionGroups=[];this._mutuallyExclusiveGroups=[];this._defaults={};this._regexpNegativeNumber=new RegExp("^[-]?[0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?$");this._hasNegativeNumberOptionals=[]},ArgumentGroup=require("./argument/group"),MutuallyExclusiveGroup=require("./argument/exclusive");ActionContainer.prototype.register=function(e,t,n){this._registries[e]=this._registries[e]||{};this._registries[e][t]=n};ActionContainer.prototype._registryGet=function(e,t,n){3>arguments.length&&(n=null);return this._registries[e][t]||n};ActionContainer.prototype.setDefaults=function(e){e=e||{};for(var t in e)this._defaults[t]=e[t];this._actions.forEach(function(t){t.dest in e&&(t.defaultValue=e[t.dest])})};ActionContainer.prototype.getDefault=function(e){var t=_.has(this._defaults,e)?this._defaults[e]:null;this._actions.forEach(function(n){n.dest===e&&_.has(n,"defaultValue")&&(t=n.defaultValue)});return t};ActionContainer.prototype.addArgument=function(e,t){e=e;t=t||{};if(!_.isArray(e))throw new TypeError("addArgument first argument should be an array");if(!_.isObject(t)||_.isArray(t))throw new TypeError("addArgument second argument should be a hash");if(!e||e.length===1&&this.prefixChars.indexOf(e[0][0])<0){if(e&&!!t.dest)throw new Error("dest supplied twice for positional argument");t=this._getPositional(e,t)}else t=this._getOptional(e,t);if(_.isUndefined(t.defaultValue)){var n=t.dest;_.has(this._defaults,n)?t.defaultValue=this._defaults[n]:_.isUndefined(this.argumentDefault)||(t.defaultValue=this.argumentDefault)}var r=this._popActionClass(t);if(!_.isFunction(r))throw new Error(format('Unknown action "%s".',r));var i=new r(t),s=this._registryGet("type",i.type,i.type);if(!_.isFunction(s))throw new Error(format('"%s" is not callable',s));return this._addAction(i)};ActionContainer.prototype.addArgumentGroup=function(e){var t=new ArgumentGroup(this,e);this._actionGroups.push(t);return t};ActionContainer.prototype.addMutuallyExclusiveGroup=function(e){var t=new MutuallyExclusiveGroup(this,e);this._mutuallyExclusiveGroups.push(t);return t};ActionContainer.prototype._addAction=function(e){var t=this;this._checkConflict(e);this._actions.push(e);e.container=this;e.optionStrings.forEach(function(n){t._optionStringActions[n]=e});e.optionStrings.forEach(function(e){e.match(t._regexpNegativeNumber)&&(_.any(t._hasNegativeNumberOptionals)||t._hasNegativeNumberOptionals.push(!0))});return e};ActionContainer.prototype._removeAction=function(e){var t=this._actions.indexOf(e);t>=0&&this._actions.splice(t,1)};ActionContainer.prototype._addContainerActions=function(e){function r(e){return e.getName()}var t={};this._actionGroups.forEach(function(e){if(t[e.title])throw new Error(format('Cannot merge actions - two groups are named "%s".',e.title));t[e.title]=e});var n={};e._actionGroups.forEach(function(e){t[e.title]||(t[e.title]=this.addArgumentGroup({title:e.title,description:e.description}));e._groupActions.forEach(function(i){n[r(i)]=t[e.title]})},this);var i;e._mutuallyExclusiveGroups.forEach(function(e){i=this.addMutuallyExclusiveGroup({required:e.required});e._groupActions.forEach(function(e){n[r(e)]=i})},this);e._actions.forEach(function(e){var t=r(e);n[t]?n[t]._addAction(e):this._addAction(e)})};ActionContainer.prototype._getPositional=function(e,t){_.isArray(e)&&(e=_.first(e));if(t.required)throw new Error('"required" is an invalid argument for positionals.');t.nargs!==$$.OPTIONAL&&t.nargs!==$$.ZERO_OR_MORE&&(t.required=!0);t.nargs===$$.ZERO_OR_MORE&&t.defaultValue===undefined&&(t.required=!0);t.dest=e;t.optionStrings=[];return t};ActionContainer.prototype._getOptional=function(e,t){var n=this.prefixChars,r=[],i=[];e.forEach(function(e){if(n.indexOf(e[0])<0)throw new Error(format('Invalid option string "%s": must start with a "%s".',e,n));r.push(e);e.length>1&&n.indexOf(e[1])>=0&&i.push(e)});var s=t.dest||null;delete t.dest;if(!s){var o=i.length?i[0]:r[0];s=_.str.strip(o,this.prefixChars);if(s.length===0)throw new Error(format('dest= is required for options like "%s"',r.join(", ")));s=s.replace(/-/g,"_")}t.dest=s;t.optionStrings=r;return t};ActionContainer.prototype._popActionClass=function(e,t){t=t||null;var n=e.action||t;delete e.action;var r=this._registryGet("action",n,n);return r};ActionContainer.prototype._getHandler=function(){var e=this.conflictHandler,t="_handleConflict"+_.str.capitalize(e),n=this[t];if(typeof n=="undefined"){var r="invalid conflict resolution value: "+e;throw new Error(r)}return n};ActionContainer.prototype._checkConflict=function(e){var t=this._optionStringActions,n=[];e.optionStrings.forEach(function(e){var r=t[e];typeof r!="undefined"&&n.push([e,r])});if(n.length>0){var r=this._getHandler();r.call(this,e,n)}};ActionContainer.prototype._handleConflictError=function(e,t){var n=_.map(t,function(e){return e[0]});n=n.join(", ");throw argumentErrorHelper(e,format("Conflicting option string(s): %s",n))};ActionContainer.prototype._handleConflictResolve=function(e,t){var n=this;t.forEach(function(e){var t=e[0],r=e[1],i=r.optionStrings.indexOf(t);i>=0&&r.optionStrings.splice(i,1);delete n._optionStringActions[t];r.optionStrings.length===0&&r.container._removeAction(r)})};