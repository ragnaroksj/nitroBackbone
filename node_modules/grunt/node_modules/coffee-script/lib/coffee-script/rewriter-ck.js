// Generated by CoffeeScript 1.3.3
(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},b=[].slice;exports.Rewriter=function(){function e(){}e.prototype.rewrite=function(e){this.tokens=e;this.removeLeadingNewlines();this.removeMidExpressionNewlines();this.closeOpenCalls();this.closeOpenIndexes();this.addImplicitIndentation();this.tagPostfixConditionals();this.addImplicitBraces();this.addImplicitParentheses();return this.tokens};e.prototype.scanTokens=function(e){var t,n,r;r=this.tokens;t=0;while(n=r[t])t+=e.call(this,n,t,r);return!0};e.prototype.detectEnd=function(e,t,i){var s,o,u,a,f;u=this.tokens;s=0;while(o=u[e]){if(s===0&&t.call(this,o,e))return i.call(this,o,e);if(!o||s<0)return i.call(this,o,e-1);if(a=o[0],y.call(r,a)>=0)s+=1;else if(f=o[0],y.call(n,f)>=0)s-=1;e+=1}return e-1};e.prototype.removeLeadingNewlines=function(){var e,t,n,r,i;i=this.tokens;for(e=n=0,r=i.length;n<r;e=++n){t=i[e][0];if(t!=="TERMINATOR")break}if(e)return this.tokens.splice(0,e)};e.prototype.removeMidExpressionNewlines=function(){return this.scanTokens(function(e,n,r){var i;if(e[0]==="TERMINATOR"&&(i=this.tag(n+1),y.call(t,i)>=0)){r.splice(n,1);return 0}return 1})};e.prototype.closeOpenCalls=function(){var e,t;t=function(e,t){var n;return(n=e[0])===")"||n==="CALL_END"||e[0]==="OUTDENT"&&this.tag(t-1)===")"};e=function(e,t){return this.tokens[e[0]==="OUTDENT"?t-1:t][0]="CALL_END"};return this.scanTokens(function(n,r){n[0]==="CALL_START"&&this.detectEnd(r+1,t,e);return 1})};e.prototype.closeOpenIndexes=function(){var e,t;t=function(e,t){var n;return(n=e[0])==="]"||n==="INDEX_END"};e=function(e,t){return e[0]="INDEX_END"};return this.scanTokens(function(n,r){n[0]==="INDEX_START"&&this.detectEnd(r+1,t,e);return 1})};e.prototype.addImplicitBraces=function(){var e,t,i,s,u,a,f,c;s=[];u=null;c=null;i=!0;a=0;f=0;t=function(e,t){var n,r,s,u,a,h;a=this.tokens.slice(t+1,t+3+1||9e9),n=a[0],u=a[1],s=a[2];if("HERECOMMENT"===(n!=null?n[0]:void 0))return!1;r=e[0];y.call(l,r)>=0&&(i=!1);return(r==="TERMINATOR"||r==="OUTDENT"||y.call(o,r)>=0&&i&&t-f!==1)&&(!c&&this.tag(t-1)!==","||(u!=null?u[0]:void 0)!==":"&&((n!=null?n[0]:void 0)!=="@"||(s!=null?s[0]:void 0)!==":"))||r===","&&n&&(h=n[0])!=="IDENTIFIER"&&h!=="NUMBER"&&h!=="STRING"&&h!=="@"&&h!=="TERMINATOR"&&h!=="OUTDENT"};e=function(e,t){var n;n=this.generate("}","}",e[2]);return this.tokens.splice(t,0,n)};return this.scanTokens(function(o,a,h){var p,d,v,m,g,b,w,E;if(w=m=o[0],y.call(r,w)>=0){s.push([m==="INDENT"&&this.tag(a-1)==="{"?"{":m,a]);return 1}if(y.call(n,m)>=0){u=s.pop();return 1}if(m!==":"||(p=this.tag(a-2))!==":"&&((E=s[s.length-1])!=null?E[0]:void 0)==="{")return 1;i=!0;f=a+1;s.push(["{"]);d=p==="@"?a-2:a-1;while(this.tag(d-2)==="HERECOMMENT")d-=2;v=this.tag(d-1);c=!v||y.call(l,v)>=0;b=new String("{");b.generated=!0;g=this.generate("{",b,o[2]);h.splice(d,0,g);this.detectEnd(a+2,t,e);return 2})};e.prototype.addImplicitParentheses=function(){var e,t,n,r,f;n=f=r=!1;t=function(e,t){var n,s,u,a;s=e[0];if(!f&&e.fromThen)return!0;if(s==="IF"||s==="ELSE"||s==="CATCH"||s==="->"||s==="=>"||s==="CLASS")f=!0;if(s==="IF"||s==="ELSE"||s==="SWITCH"||s==="TRY"||s==="=")r=!0;return s!=="."&&s!=="?."&&s!=="::"||this.tag(t-1)!=="OUTDENT"?!e.generated&&this.tag(t-1)!==","&&(y.call(o,s)>=0||s==="INDENT"&&!r)&&(s!=="INDENT"||(u=this.tag(t-2))!=="CLASS"&&u!=="EXTENDS"&&(a=this.tag(t-1),y.call(i,a)<0)&&(!(n=this.tokens[t+1])||!n.generated||n[0]!=="{")):!0};e=function(e,t){return this.tokens.splice(t,0,this.generate("CALL_END",")",e[2]))};return this.scanTokens(function(i,o,c){var h,p,d,v,m,g,b,w;m=i[0];if(m==="CLASS"||m==="IF"||m==="FOR"||m==="WHILE")n=!0;g=c.slice(o-1,o+1+1||9e9),v=g[0],p=g[1],d=g[2];h=!n&&m==="INDENT"&&d&&d.generated&&d[0]==="{"&&v&&(b=v[0],y.call(u,b)>=0);f=!1;r=!1;y.call(l,m)>=0&&(n=!1);v&&!v.spaced&&m==="?"&&(i.call=!0);if(i.fromThen)return 1;if(!(h||(v!=null?v.spaced:void 0)&&(v.call||(w=v[0],y.call(u,w)>=0))&&(y.call(s,m)>=0||!i.spaced&&!i.newLine&&y.call(a,m)>=0)))return 1;c.splice(o,0,this.generate("CALL_START","(",i[2]));this.detectEnd(o+1,t,e);v[0]==="?"&&(v[0]="FUNC_EXIST");return 2})};e.prototype.addImplicitIndentation=function(){var e,t,n,r,i;i=n=r=null;t=function(e,t){var n;return e[1]!==";"&&(n=e[0],y.call(c,n)>=0)&&(e[0]!=="ELSE"||i==="IF"||i==="THEN")};e=function(e,t){return this.tokens.splice(this.tag(t-1)===","?t-1:t,0,r)};return this.scanTokens(function(s,o,u){var a,f,l;a=s[0];if(a==="TERMINATOR"&&this.tag(o+1)==="THEN"){u.splice(o,1);return 0}if(a==="ELSE"&&this.tag(o-1)!=="OUTDENT"){u.splice.apply(u,[o,0].concat(b.call(this.indentation(s))));return 2}if(a!=="CATCH"||(f=this.tag(o+2))!=="OUTDENT"&&f!=="TERMINATOR"&&f!=="FINALLY"){if(y.call(h,a)>=0&&this.tag(o+1)!=="INDENT"&&(a!=="ELSE"||this.tag(o+1)!=="IF")){i=a;l=this.indentation(s,!0),n=l[0],r=l[1];i==="THEN"&&(n.fromThen=!0);u.splice(o+1,0,n);this.detectEnd(o+2,t,e);a==="THEN"&&u.splice(o,1);return 1}return 1}u.splice.apply(u,[o+2,0].concat(b.call(this.indentation(s))));return 4})};e.prototype.tagPostfixConditionals=function(){var e,t,n;n=null;t=function(e,t){var n;return(n=e[0])==="TERMINATOR"||n==="INDENT"};e=function(e,t){if(e[0]!=="INDENT"||e.generated&&!e.fromThen)return n[0]="POST_"+n[0]};return this.scanTokens(function(r,i){if(r[0]!=="IF")return 1;n=r;this.detectEnd(i+1,t,e);return 1})};e.prototype.indentation=function(e,t){var n,r;t==null&&(t=!1);n=["INDENT",2,e[2]];r=["OUTDENT",2,e[2]];t&&(n.generated=r.generated=!0);return[n,r]};e.prototype.generate=function(e,t,n){var r;r=[e,t,n];r.generated=!0;return r};e.prototype.tag=function(e){var t;return(t=this.tokens[e])!=null?t[0]:void 0};return e}();e=[["(",")"],["[","]"],["{","}"],["INDENT","OUTDENT"],["CALL_START","CALL_END"],["PARAM_START","PARAM_END"],["INDEX_START","INDEX_END"]];exports.INVERSES=f={};r=[];n=[];for(v=0,m=e.length;v<m;v++){g=e[v],p=g[0],d=g[1];r.push(f[d]=p);n.push(f[p]=d)}t=["CATCH","WHEN","ELSE","FINALLY"].concat(n);u=["IDENTIFIER","SUPER",")","CALL_END","]","INDEX_END","@","THIS"];s=["IDENTIFIER","NUMBER","STRING","JS","REGEX","NEW","PARAM_START","CLASS","IF","TRY","SWITCH","THIS","BOOL","NULL","UNDEFINED","UNARY","SUPER","@","->","=>","[","(","{","--","++"];a=["+","-"];i=["->","=>","{","[",","];o=["POST_IF","FOR","WHILE","UNTIL","WHEN","BY","LOOP","TERMINATOR"];h=["ELSE","->","=>","TRY","FINALLY","THEN"];c=["TERMINATOR","CATCH","FINALLY","ELSE","OUTDENT","LEADING_WHEN"];l=["TERMINATOR","INDENT","OUTDENT"]}).call(this);