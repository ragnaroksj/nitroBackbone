// Generated by CoffeeScript 1.3.3
(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};V=require("./rewriter"),P=V.Rewriter,m=V.INVERSES;$=require("./helpers"),U=$.count,X=$.starts,R=$.compact,W=$.last;exports.Lexer=x=function(){function e(){}e.prototype.tokenize=function(e,t){var n,r;t==null&&(t={});q.test(e)&&(e="\n"+e);e=e.replace(/\r/g,"").replace(F,"");this.code=e;this.line=t.line||0;this.indent=0;this.indebt=0;this.outdebt=0;this.indents=[];this.ends=[];this.tokens=[];n=0;while(this.chunk=e.slice(n))n+=this.identifierToken()||this.commentToken()||this.whitespaceToken()||this.lineToken()||this.heredocToken()||this.stringToken()||this.numberToken()||this.regexToken()||this.jsToken()||this.literalToken();this.closeIndentation();(r=this.ends.pop())&&this.error("missing "+r);return t.rewrite===!1?this.tokens:(new P).rewrite(this.tokens)};e.prototype.identifierToken=function(){var e,t,n,o,u,a,f,l,c;if(!(u=d.exec(this.chunk)))return 0;o=u[0],n=u[1],e=u[2];if(n==="own"&&this.tag()==="FOR"){this.token("OWN",n);return n.length}t=e||(a=W(this.tokens))&&((l=a[0])==="."||l==="?."||l==="::"||!a.spaced&&a[0]==="@");f="IDENTIFIER";if(!t&&(J.call(b,n)>=0||J.call(s,n)>=0)){f=n.toUpperCase();if(f==="WHEN"&&(c=this.tag(),J.call(w,c)>=0))f="LEADING_WHEN";else if(f==="FOR")this.seenFor=!0;else if(f==="UNLESS")f="IF";else if(J.call(I,f)>=0)f="UNARY";else if(J.call(_,f)>=0)if(f!=="INSTANCEOF"&&this.seenFor){f="FOR"+f;this.seenFor=!1}else{f="RELATION";if(this.value()==="!"){this.tokens.pop();n="!"+n}}}if(J.call(y,n)>=0)if(t){f="IDENTIFIER";n=new String(n);n.reserved=!0}else J.call(D,n)>=0&&this.error('reserved word "'+n+'"');if(!t){J.call(r,n)>=0&&(n=i[n]);f=function(){switch(n){case"!":return"UNARY";case"==":case"!=":return"COMPARE";case"&&":case"||":return"LOGIC";case"true":case"false":return"BOOL";case"break":case"continue":return"STATEMENT";default:return f}}()}this.token(f,n);e&&this.token(":",":");return o.length};e.prototype.numberToken=function(){var e,t,n,r,i;if(!(n=A.exec(this.chunk)))return 0;r=n[0];/^0[BOX]/.test(r)?this.error("radix prefix '"+r+"' must be lowercase"):/E/.test(r)&&!/^0x/.test(r)?this.error("exponential notation '"+r+"' must be indicated with a lowercase 'e'"):/^0\d*[89]/.test(r)?this.error("decimal literal '"+r+"' must not be prefixed with '0'"):/^0\d+/.test(r)&&this.error("octal literal '"+r+"' must be prefixed with '0o'");t=r.length;if(i=/^0o([0-7]+)/.exec(r))r="0x"+parseInt(i[1],8).toString(16);if(e=/^0b([01]+)/.exec(r))r="0x"+parseInt(e[1],2).toString(16);this.token("NUMBER",r);return t};e.prototype.stringToken=function(){var e,t,n;switch(this.chunk.charAt(0)){case"'":if(!(e=B.exec(this.chunk)))return 0;this.token("STRING",(n=e[0]).replace(N,"\\\n"));break;case'"':if(!(n=this.balancedString(this.chunk,'"')))return 0;0<n.indexOf("#{",1)?this.interpolateString(n.slice(1,-1)):this.token("STRING",this.escapeLines(n));break;default:return 0}(t=/^(?:\\.|[^\\])*\\(?:0[0-7]|[1-7])/.test(n))&&this.error("octal escape sequences "+n+" are not allowed");this.line+=U(n,"\n");return n.length};e.prototype.heredocToken=function(){var e,t,n,r;if(!(n=f.exec(this.chunk)))return 0;t=n[0];r=t.charAt(0);e=this.sanitizeHeredoc(n[2],{quote:r,indent:null});r==='"'&&0<=e.indexOf("#{")?this.interpolateString(e,{heredoc:!0}):this.token("STRING",this.makeString(e,r,!0));this.line+=U(t,"\n");return t.length};e.prototype.commentToken=function(){var e,t,n;if(!(n=this.chunk.match(o)))return 0;e=n[0],t=n[1];t&&this.token("HERECOMMENT",this.sanitizeHeredoc(t,{herecomment:!0,indent:Array(this.indent+1).join(" ")}));this.line+=U(e,"\n");return e.length};e.prototype.jsToken=function(){var e,t;if(this.chunk.charAt(0)!=="`"||!(e=g.exec(this.chunk)))return 0;this.token("JS",(t=e[0]).slice(1,-1));return t.length};e.prototype.regexToken=function(){var e,t,n,r,i,s,o;if(this.chunk.charAt(0)!=="/")return 0;if(n=h.exec(this.chunk)){t=this.heregexToken(n);this.line+=U(n[0],"\n");return t}r=W(this.tokens);if(r&&(s=r[0],J.call(r.spaced?k:L,s)>=0))return 0;if(!(n=M.exec(this.chunk)))return 0;o=n,n=o[0],i=o[1],e=o[2];i.slice(0,2)==="/*"&&this.error("regular expressions cannot begin with `*`");i==="//"&&(i="/(?:)/");this.token("REGEX",""+i+e);return n.length};e.prototype.heregexToken=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,d;r=e[0],t=e[1],n=e[2];if(0>t.indexOf("#{")){i=t.replace(p,"").replace(/\//g,"\\/");i.match(/^\*/)&&this.error("regular expressions cannot begin with `*`");this.token("REGEX","/"+(i||"(?:)")+"/"+n);return r.length}this.token("IDENTIFIER","RegExp");this.tokens.push(["CALL_START","("]);o=[];l=this.interpolateString(t,{regex:!0});for(a=0,f=l.length;a<f;a++){c=l[a],s=c[0],u=c[1];if(s==="TOKENS")o.push.apply(o,u);else{if(!(u=u.replace(p,"")))continue;u=u.replace(/\\/g,"\\\\");o.push(["STRING",this.makeString(u,'"',!0)])}o.push(["+","+"])}o.pop();((h=o[0])!=null?h[0]:void 0)!=="STRING"&&this.tokens.push(["STRING",'""'],["+","+"]);(d=this.tokens).push.apply(d,o);n&&this.tokens.push([",",","],["STRING",'"'+n+'"']);this.token(")",")");return r.length};e.prototype.lineToken=function(){var e,t,n,r,i,s;if(!(n=C.exec(this.chunk)))return 0;t=n[0];this.line+=U(t,"\n");this.seenFor=!1;i=W(this.tokens,1);s=t.length-1-t.lastIndexOf("\n");r=this.unfinished();if(s-this.indebt===this.indent){r?this.suppressNewlines():this.newlineToken();return t.length}if(s>this.indent){if(r){this.indebt=s-this.indent;this.suppressNewlines();return t.length}e=s-this.indent+this.outdebt;this.token("INDENT",e);this.indents.push(e);this.ends.push("OUTDENT");this.outdebt=this.indebt=0}else{this.indebt=0;this.outdentToken(this.indent-s,r)}this.indent=s;return t.length};e.prototype.outdentToken=function(e,t){var n,r;while(e>0){r=this.indents.length-1;if(this.indents[r]===void 0)e=0;else if(this.indents[r]===this.outdebt){e-=this.outdebt;this.outdebt=0}else if(this.indents[r]<this.outdebt){this.outdebt-=this.indents[r];e-=this.indents[r]}else{n=this.indents.pop()-this.outdebt;e-=n;this.outdebt=0;this.pair("OUTDENT");this.token("OUTDENT",n)}}n&&(this.outdebt-=e);while(this.value()===";")this.tokens.pop();this.tag()!=="TERMINATOR"&&!t&&this.token("TERMINATOR","\n");return this};e.prototype.whitespaceToken=function(){var e,t,n;if(!(e=q.exec(this.chunk))&&!(t=this.chunk.charAt(0)==="\n"))return 0;n=W(this.tokens);n&&(n[e?"spaced":"newLine"]=!0);return e?e[0].length:0};e.prototype.newlineToken=function(){while(this.value()===";")this.tokens.pop();this.tag()!=="TERMINATOR"&&this.token("TERMINATOR","\n");return this};e.prototype.suppressNewlines=function(){this.value()==="\\"&&this.tokens.pop();return this};e.prototype.literalToken=function(){var e,r,i,s,o,f,l,c;if(e=O.exec(this.chunk)){s=e[0];n.test(s)&&this.tagParameters()}else s=this.chunk.charAt(0);i=s;r=W(this.tokens);if(s==="="&&r){!r[1].reserved&&(o=r[1],J.call(y,o)>=0)&&this.error('reserved word "'+this.value()+"\" can't be assigned");if((f=r[1])==="||"||f==="&&"){r[0]="COMPOUND_ASSIGN";r[1]+="=";return s.length}}if(s===";"){this.seenFor=!1;i="TERMINATOR"}else if(J.call(T,s)>=0)i="MATH";else if(J.call(u,s)>=0)i="COMPARE";else if(J.call(a,s)>=0)i="COMPOUND_ASSIGN";else if(J.call(I,s)>=0)i="UNARY";else if(J.call(H,s)>=0)i="SHIFT";else if(J.call(S,s)>=0||s==="?"&&(r!=null?r.spaced:void 0))i="LOGIC";else if(r&&!r.spaced)if(s==="("&&(l=r[0],J.call(t,l)>=0)){r[0]==="?"&&(r[0]="FUNC_EXIST");i="CALL_START"}else if(s==="["&&(c=r[0],J.call(v,c)>=0)){i="INDEX_START";switch(r[0]){case"?":r[0]="INDEX_SOAK"}}switch(s){case"(":case"{":case"[":this.ends.push(m[s]);break;case")":case"}":case"]":this.pair(s)}this.token(i,s);return s.length};e.prototype.sanitizeHeredoc=function(e,t){var n,r,i,s,o;i=t.indent,r=t.herecomment;if(r){l.test(e)&&this.error('block comment cannot contain "*/", starting');if(e.indexOf("\n")<=0)return e}else while(s=c.exec(e)){n=s[1];if(i===null||0<(o=n.length)&&o<i.length)i=n}i&&(e=e.replace(RegExp("\\n"+i,"g"),"\n"));r||(e=e.replace(/^\n/,""));return e};e.prototype.tagParameters=function(){var e,t,n,r;if(this.tag()!==")")return this;t=[];r=this.tokens;e=r.length;r[--e][0]="PARAM_END";while(n=r[--e])switch(n[0]){case")":t.push(n);break;case"(":case"CALL_START":if(!t.length){if(n[0]==="("){n[0]="PARAM_START";return this}return this}t.pop()}return this};e.prototype.closeIndentation=function(){return this.outdentToken(this.indent)};e.prototype.balancedString=function(e,t){var n,r,i,s,o,u,a,f;n=0;u=[t];for(r=a=1,f=e.length;1<=f?a<f:a>f;r=1<=f?++a:--a){if(n){--n;continue}switch(i=e.charAt(r)){case"\\":++n;continue;case t:u.pop();if(!u.length)return e.slice(0,r+1||9e9);t=u[u.length-1];continue}t!=="}"||i!=='"'&&i!=="'"?t==="}"&&i==="/"&&(s=h.exec(e.slice(r))||M.exec(e.slice(r)))?n+=s[0].length-1:t==="}"&&i==="{"?u.push(t="}"):t==='"'&&o==="#"&&i==="{"&&u.push(t="}"):u.push(t=i);o=i}return this.error("missing "+u.pop()+", starting")};e.prototype.interpolateString=function(t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;n==null&&(n={});i=n.heredoc,h=n.regex;d=[];c=0;s=-1;while(f=t.charAt(s+=1)){if(f==="\\"){s+=1;continue}if(f!=="#"||t.charAt(s+1)!=="{"||!(r=this.balancedString(t.slice(s+1),"}")))continue;c<s&&d.push(["NEOSTRING",t.slice(c,s)]);o=r.slice(1,-1);if(o.length){l=(new e).tokenize(o,{line:this.line,rewrite:!1});l.pop();((y=l[0])!=null?y[0]:void 0)==="TERMINATOR"&&l.shift();if(a=l.length){if(a>1){l.unshift(["(","(",this.line]);l.push([")",")",this.line])}d.push(["TOKENS",l])}}s+=r.length;c=s+1}s>c&&c<t.length&&d.push(["NEOSTRING",t.slice(c)]);if(h)return d;if(!d.length)return this.token("STRING",'""');d[0][0]!=="NEOSTRING"&&d.unshift(["",""]);(u=d.length>1)&&this.token("(","(");for(s=m=0,g=d.length;m<g;s=++m){b=d[s],p=b[0],v=b[1];s&&this.token("+","+");p==="TOKENS"?(w=this.tokens).push.apply(w,v):this.token("STRING",this.makeString(v,'"',i))}u&&this.token(")",")");return d};e.prototype.pair=function(e){var t,n;if(e!==(n=W(this.ends))){"OUTDENT"!==n&&this.error("unmatched "+e);this.indent-=t=W(this.indents);this.outdentToken(t,!0);return this.pair(e)}return this.ends.pop()};e.prototype.token=function(e,t){return this.tokens.push([e,t,this.line])};e.prototype.tag=function(e,t){var n;return(n=W(this.tokens,e))&&(t?n[0]=t:n[0])};e.prototype.value=function(e,t){var n;return(n=W(this.tokens,e))&&(t?n[1]=t:n[1])};e.prototype.unfinished=function(){var e;return E.test(this.chunk)||(e=this.tag())==="\\"||e==="."||e==="?."||e==="UNARY"||e==="MATH"||e==="+"||e==="-"||e==="SHIFT"||e==="RELATION"||e==="COMPARE"||e==="LOGIC"||e==="THROW"||e==="EXTENDS"};e.prototype.escapeLines=function(e,t){return e.replace(N,t?"\\n":"")};e.prototype.makeString=function(e,t,n){if(!e)return t+t;e=e.replace(/\\([\s\S])/g,function(e,n){return n==="\n"||n===t?n:e});e=e.replace(RegExp(""+t,"g"),"\\$&");return t+this.escapeLines(e,n)+t};e.prototype.error=function(e){throw SyntaxError(""+e+" on line "+(this.line+1))};return e}();b=["true","false","null","this","new","delete","typeof","in","instanceof","return","throw","break","continue","debugger","if","else","switch","for","while","do","try","catch","finally","class","extends","super"];s=["undefined","then","unless","until","loop","of","by","when"];i={and:"&&",or:"||",is:"==",isnt:"!=",not:"!",yes:"true",no:"false",on:"true",off:"false"};r=function(){var e;e=[];for(z in i)e.push(z);return e}();s=s.concat(r);D=["case","default","function","var","void","with","const","let","enum","export","import","native","__hasProp","__extends","__slice","__bind","__indexOf","implements","interface","let","package","private","protected","public","static","yield"];j=["arguments","eval"];y=b.concat(D).concat(j);exports.RESERVED=D.concat(b).concat(s).concat(j);exports.STRICT_PROSCRIBED=j;d=/^([$A-Za-z_\x7f-\uffff][$\w\x7f-\uffff]*)([^\n\S]*:(?!:))?/;A=/^0b[01]+|^0o[0-7]+|^0x[\da-f]+|^\d*\.?\d+(?:e[+-]?\d+)?/i;f=/^("""|''')([\s\S]*?)(?:\n[^\n\S]*)?\1/;O=/^(?:[-=]>|[-+*\/%<>&|^!?=]=|>>>=?|([-+:])\1|([&|<>])\2=?|\?\.|\.{2,3})/;q=/^[^\n\S]+/;o=/^###([^#][\s\S]*?)(?:###[^\n\S]*|(?:###)?$)|^(?:\s*#(?!##[^#]).*)+/;n=/^[-=]>/;C=/^(?:\n[^\n\S]*)+/;B=/^'[^\\']*(?:\\.[^\\']*)*'/;g=/^`[^\\`]*(?:\\.[^\\`]*)*`/;M=/^(\/(?![\s=])[^[\/\n\\]*(?:(?:\\[\s\S]|\[[^\]\n\\]*(?:\\[\s\S][^\]\n\\]*)*])[^[\/\n\\]*)*\/)([imgy]{0,4})(?!\w)/;h=/^\/{3}([\s\S]+?)\/{3}([imgy]{0,4})(?!\w)/;p=/\s+(?:#.*)?/g;N=/\n/g;c=/\n+([^\n\S]*)/g;l=/\*\//;E=/^\s*(?:,|\??\.(?![.\d])|::)/;F=/\s+$/;a=["-=","+=","/=","*=","%=","||=","&&=","?=","<<=",">>=",">>>=","&=","^=","|="];I=["!","~","NEW","TYPEOF","DELETE","DO"];S=["&&","||","&","|","^"];H=["<<",">>",">>>"];u=["==","!=","<",">","<=",">="];T=["*","/","%"];_=["IN","OF","INSTANCEOF"];e=["TRUE","FALSE"];k=["NUMBER","REGEX","BOOL","NULL","UNDEFINED","++","--","]"];L=k.concat(")","}","THIS","IDENTIFIER","STRING");t=["IDENTIFIER","STRING","REGEX",")","]","}","?","::","@","THIS","SUPER"];v=t.concat("NUMBER","BOOL","NULL","UNDEFINED");w=["INDENT","OUTDENT","TERMINATOR"]}).call(this);