/*
 * grunt
 * http://gruntjs.com/
 *
 * Copyright (c) 2014 "Cowboy" Ben Alman
 * Licensed under the MIT license.
 * https://github.com/gruntjs/grunt/blob/master/LICENSE-MIT
 */"use strict";function Log(e){this.always=this;this.options=_.extend({},{color:!0,verbose:!1,debug:!1,outStream:process.stdout,grunt:null,maxCols:null,muted:!1},e);this.hasLogged=!1;this.verbose=new VerboseLog(this,!0);this.notverbose=new VerboseLog(this,!1);this.verbose.or=this.notverbose;this.notverbose.or=this.verbose;if(this.options.grunt){_.bindAll(this);_.bindAll(this.verbose);_.bindAll(this.notverbose)}}function VerboseLog(e,t){this.always=e;this._isVerbose=t}function makeSmartAccessor(e,t){Object.defineProperty(Log.prototype,e,{enumerable:!0,configurable:!0,get:function(){return t?this.always._options[e]:this.always["_"+e]},set:function(n){t?this.always._options[e]=n:this.always["_"+e]=n}})}var util=require("util"),hooker=require("hooker"),colors=require("colors"),_=require("lodash");_.str=require("underscore.string");_.mixin(_.str.exports());exports.Log=Log;util.inherits(VerboseLog,Log);VerboseLog.prototype._write=function(){if(Boolean(this.option("verbose"))!==this._isVerbose)return;return VerboseLog.super_.prototype._write.apply(this,arguments)};makeSmartAccessor("options");makeSmartAccessor("hasLogged");makeSmartAccessor("muted",!0);Log.prototype.initColors=function(){if(this.option("no-color")){colors.mode="none";hooker.hook(console,"log",function(){var e=_.toArray(arguments);return hooker.filter(this,e.map(function(e){return typeof e=="string"?colors.stripColors(e):e}))})}};Log.prototype.option=function(e){if(this.options.grunt&&this.options.grunt.option)return this.options.grunt.option(e);var t=e.match(/^no-(.+)$/);return t?!this.options[t[1]]:this.options[e]};Log.prototype._markup=function(e){e=e||"";e=e.replace(/(\s|^)_(\S|\S[\s\S]+?\S)_(?=[\s,.!?]|$)/g,"$1"+"$2".underline);e=e.replace(/(\s|^)\*(\S|\S[\s\S]+?\S)\*(?=[\s,.!?]|$)/g,"$1"+"$2".bold);return e};Log.prototype._format=function(e){e=_.toArray(e);e.length>0&&(e[0]=String(e[0]));return util.format.apply(util,e)};Log.prototype._write=function(e){if(this.muted)return;this.hasLogged=!0;e=e||"";this.option("no-color")&&(e=colors.stripColors(e));this.options.outStream.write(this._markup(e))};Log.prototype._writeln=function(e){this._write((e||"")+"\n")};Log.prototype.write=function(){this._write(this._format(arguments));return this};Log.prototype.writeln=function(){this._writeln(this._format(arguments));return this};Log.prototype.warn=function(){var e=this._format(arguments);arguments.length>0?this._writeln(">> ".red+_.trim(e).replace(/\n/g,"\n>> ".red)):this._writeln("ERROR".red);return this};Log.prototype.error=function(){this.options.grunt&&this.options.grunt.fail&&this.options.grunt.fail.errorcount++;this.warn.apply(this,arguments);return this};Log.prototype.ok=function(){var e=this._format(arguments);arguments.length>0?this._writeln(">> ".green+_.trim(e).replace(/\n/g,"\n>> ".green)):this._writeln("OK".green);return this};Log.prototype.errorlns=function(){var e=this._format(arguments);this.error(this.wraptext(this.options.maxCols||77,e));return this};Log.prototype.oklns=function(){var e=this._format(arguments);this.ok(this.wraptext(this.options.maxCols||77,e));return this};Log.prototype.success=function(){var e=this._format(arguments);this._writeln(e.green);return this};Log.prototype.fail=function(){var e=this._format(arguments);this._writeln(e.red);return this};Log.prototype.header=function(){var e=this._format(arguments);this.hasLogged&&this._writeln();this._writeln(e.underline);return this};Log.prototype.subhead=function(){var e=this._format(arguments);this.hasLogged&&this._writeln();this._writeln(e.bold);return this};Log.prototype.debug=function(){var e=this._format(arguments);this.option("debug")&&this._writeln("[D] "+e.magenta);return this};Log.prototype.writetableln=function(e,t){this._writeln(this.table(e,t));return this};Log.prototype.writelns=function(){var e=this._format(arguments);this._writeln(this.wraptext(this.options.maxCols||80,e));return this};Log.prototype.writeflags=function(e,t){var n;Array.isArray(e)?n=this.wordlist(e):typeof e=="object"&&e&&(n=this.wordlist(Object.keys(e).map(function(t){var n=e[t];return t+(n===!0?"":"="+JSON.stringify(n))})));this._writeln((t||"Flags")+": "+(n||"(none)".cyan));return this};Log.prototype.wordlist=exports.wordlist=function(e,t){t=_.defaults(t||{},{separator:", ",color:"cyan"});return e.map(function(e){return t.color?String(e)[t.color]:e}).join(t.separator)};Log.prototype.uncolor=exports.uncolor=function(e){return e.replace(/\x1B\[\d+m/g,"")};Log.prototype.wraptext=exports.wraptext=function(e,t){var n=[],r,i,s,o=[],u=0;while(r=t.match(/(?:(\x1B\[\d+m)|\n|(.))([\s\S]*)/)){t=r[3];if(r[1]){i=r[1];o.push(r[1]);continue}if(r[2]){u===0&&i&&o.push(i);o.push(r[2]);u++;if(u<=e||r[2]===" ")continue;s=o.lastIndexOf(" ");t=o.slice(s===-1?s:s+1).join("")+t;o=o.slice(0,s)}n.push(o.join(""));o=[];u=0}n.push(o.join(""));return n.join("\n")};Log.prototype.table=exports.table=function(e,t){var n=[];e.forEach(function(e,r){var i=this.wraptext(e,t[r]).split("\n");i.forEach(function(e,t){var i=n[t];i||(i=n[t]=[]);i[r]=e})},this);var r=[];n.forEach(function(t){var n="",i;for(var s=0;s<t.length;s++){i=t[s]||"";n+=i;var o=e[s]-this.uncolor(i).length;o>0&&(n+=_.repeat(" ",o))}r.push(n)},this);return r.join("\n")};