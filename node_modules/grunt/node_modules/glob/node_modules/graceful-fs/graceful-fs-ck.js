// this keeps a queue of opened file descriptors, and will make
// fs operations wait until some have closed before trying to open more.
function OpenReq(e,t,n,r){this.path=e;this.flags=t;this.mode=n;this.cb=r}function noop(){}function gracefulOpen(e,t,n,r){typeof n=="function"&&(r=n,n=null);typeof r!="function"&&(r=noop);if(fs._curOpen>=fs.MAX_OPEN){queue.push(new OpenReq(e,t,n,r));setTimeout(flush);return}open(e,t,n,function(i,s){if(i&&i.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.open(e,t,n,r)}r(i,s)})}function open(e,t,n,r){r=r||noop;fs._curOpen++;fs._originalFs.open.call(fs,e,t,n,function(e,t){e&&onclose();r(e,t)})}function onclose(){fs._curOpen--;flush()}function flush(){while(fs._curOpen<fs.MAX_OPEN){var e=queue.shift();if(!e)return;switch(e.constructor.name){case"OpenReq":open(e.path,e.flags||"r",e.mode||511,e.cb);break;case"ReaddirReq":readdir(e.path,e.cb);break;case"ReadFileReq":readFile(e.path,e.options,e.cb);break;case"WriteFileReq":writeFile(e.path,e.data,e.options,e.cb);break;default:throw new Error("Unknown req type: "+e.constructor.name)}}}function gracefulReaddir(e,t){if(fs._curOpen>=fs.MAX_OPEN){queue.push(new ReaddirReq(e,t));setTimeout(flush);return}readdir(e,function(n,r){if(n&&n.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.readdir(e,t)}t(n,r)})}function readdir(e,t){t=t||noop;fs._curOpen++;fs._originalFs.readdir.call(fs,e,function(e,n){onclose();t(e,n)})}function ReaddirReq(e,t){this.path=e;this.cb=t}function gracefulReadFile(e,t,n){typeof t=="function"&&(n=t,t=null);typeof n!="function"&&(n=noop);if(fs._curOpen>=fs.MAX_OPEN){queue.push(new ReadFileReq(e,t,n));setTimeout(flush);return}readFile(e,t,function(r,i){if(r&&r.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.readFile(e,t,n)}n(r,i)})}function readFile(e,t,n){n=n||noop;fs._curOpen++;fs._originalFs.readFile.call(fs,e,t,function(e,t){onclose();n(e,t)})}function ReadFileReq(e,t,n){this.path=e;this.options=t;this.cb=n}function gracefulWriteFile(e,t,n,r){typeof n=="function"&&(r=n,n=null);typeof r!="function"&&(r=noop);if(fs._curOpen>=fs.MAX_OPEN){queue.push(new WriteFileReq(e,t,n,r));setTimeout(flush);return}writeFile(e,t,n,function(i){if(i&&i.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN){fs.MAX_OPEN=fs._curOpen-1;return fs.writeFile(e,t,n,r)}r(i)})}function writeFile(e,t,n,r){r=r||noop;fs._curOpen++;fs._originalFs.writeFile.call(fs,e,t,n,function(e){onclose();r(e)})}function WriteFileReq(e,t,n,r){this.path=e;this.data=t;this.options=n;this.cb=r}function chownFix(e){return e?function(t,n,r,i){return e.call(fs,t,n,r,function(e,t){chownErOk(e)&&(e=null);i(e,t)})}:e}function chownFixSync(e){return e?function(t,n,r){try{return e.call(fs,t,n,r)}catch(i){if(!chownErOk(i))throw i}}:e}function chownErOk(e){if(!e||(!process.getuid||process.getuid()!==0)&&(e.code==="EINVAL"||e.code==="EPERM"))return!0}var fs=exports=module.exports={};fs._originalFs=require("fs");Object.getOwnPropertyNames(fs._originalFs).forEach(function(e){var t=Object.getOwnPropertyDescriptor(fs._originalFs,e);Object.defineProperty(fs,e,t)});var queue=[],constants=require("constants");fs._curOpen=0;fs.MIN_MAX_OPEN=64;fs.MAX_OPEN=1024;fs.open=gracefulOpen;fs.openSync=function(e,t,n){var r;r=fs._originalFs.openSync.call(fs,e,t,n);fs._curOpen++;return r};fs.close=function(e,t){t=t||noop;fs._originalFs.close.call(fs,e,function(e){onclose();t(e)})};fs.closeSync=function(e){try{return fs._originalFs.closeSync.call(fs,e)}finally{onclose()}};fs.readdir=gracefulReaddir;fs.readFile=gracefulReadFile;fs.writeFile=gracefulWriteFile;var constants=require("constants");if(constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)){fs.lchmod=function(e,t,n){n=n||noop;fs.open(e,constants.O_WRONLY|constants.O_SYMLINK,t,function(e,r){if(e){n(e);return}fs.fchmod(r,t,function(e){fs.close(r,function(t){n(e||t)})})})};fs.lchmodSync=function(e,t){var n=fs.openSync(e,constants.O_WRONLY|constants.O_SYMLINK,t),r,i;try{var s=fs.fchmodSync(n,t)}catch(o){r=o}try{fs.closeSync(n)}catch(o){i=o}if(r||i)throw r||i;return s}}if(!fs.lutimes)if(constants.hasOwnProperty("O_SYMLINK")){fs.lutimes=function(e,t,n,r){fs.open(e,constants.O_SYMLINK,function(e,i){r=r||noop;if(e)return r(e);fs.futimes(i,t,n,function(e){fs.close(i,function(t){return r(e||t)})})})};fs.lutimesSync=function(e,t,n){var r=fs.openSync(e,constants.O_SYMLINK),i,s,o;try{var o=fs.futimesSync(r,t,n)}catch(u){i=u}try{fs.closeSync(r)}catch(u){s=u}if(i||s)throw i||s;return o}}else if(fs.utimensat&&constants.hasOwnProperty("AT_SYMLINK_NOFOLLOW")){fs.lutimes=function(e,t,n,r){fs.utimensat(e,t,n,constants.AT_SYMLINK_NOFOLLOW,r)};fs.lutimesSync=function(e,t,n){return fs.utimensatSync(e,t,n,constants.AT_SYMLINK_NOFOLLOW)}}else{fs.lutimes=function(e,t,n,r){process.nextTick(r)};fs.lutimesSync=function(){}}fs.chown=chownFix(fs.chown);fs.fchown=chownFix(fs.fchown);fs.lchown=chownFix(fs.lchown);fs.chownSync=chownFixSync(fs.chownSync);fs.fchownSync=chownFixSync(fs.fchownSync);fs.lchownSync=chownFixSync(fs.lchownSync);if(!fs.lchmod){fs.lchmod=function(e,t,n){process.nextTick(n)};fs.lchmodSync=function(){}}if(!fs.lchown){fs.lchown=function(e,t,n,r){process.nextTick(r)};fs.lchownSync=function(){}}if(process.platform==="win32"){var rename_=fs.rename;fs.rename=function(t,n,r){var i=Date.now();rename_(t,n,function s(e){if(e&&(e.code==="EACCES"||e.code==="EPERM")&&Date.now()-i<1e3)return rename_(t,n,s);r(e)})}}var read=fs.read;fs.read=function(e,t,n,r,i,s){var o;if(s&&typeof s=="function"){var u=0;o=function(a,f,l){if(a&&a.code==="EAGAIN"&&u<10){u++;return read.call(fs,e,t,n,r,i,o)}s.apply(this,arguments)}}return read.call(fs,e,t,n,r,i,o)};var readSync=fs.readSync;fs.readSync=function(e,t,n,r,i){var s=0;for(;;)try{return readSync.call(fs,e,t,n,r,i)}catch(o){if(o.code==="EAGAIN"&&s<10){s++;continue}throw o}};