// info about each config option.
function nopt(e,t,n,r){n=n||process.argv;e=e||{};t=t||{};typeof r!="number"&&(r=2);debug(e,t,n,r);n=n.slice(r);var i={},s,o=[],u=n,a=n.slice(0);parse(n,i,o,e,t);clean(i,e,exports.typeDefs);i.argv={remain:o,cooked:u,original:a};i.argv.toString=function(){return this.original.map(JSON.stringify).join(" ")};return i}function clean(e,t,n){n=n||exports.typeDefs;var r={},i=[!1,!0,null,String,Number];Object.keys(e).forEach(function(s){if(s==="argv")return;var o=e[s],u=Array.isArray(o),a=t[s];u||(o=[o]);a||(a=i);a===Array&&(a=i.concat(Array));Array.isArray(a)||(a=[a]);debug("val=%j",o);debug("types=",a);o=o.map(function(i){if(typeof i=="string"){debug("string %j",i);i=i.trim();if(i==="null"&&~a.indexOf(null)||i==="true"&&(~a.indexOf(!0)||~a.indexOf(Boolean))||i==="false"&&(~a.indexOf(!1)||~a.indexOf(Boolean))){i=JSON.parse(i);debug("jsonable %j",i)}else if(~a.indexOf(Number)&&!isNaN(i)){debug("convert to number",i);i=+i}else if(~a.indexOf(Date)&&!isNaN(Date.parse(i))){debug("convert to date",i);i=new Date(i)}}if(!t.hasOwnProperty(s))return i;i===!1&&~a.indexOf(null)&&!~a.indexOf(!1)&&!~a.indexOf(Boolean)&&(i=null);var o={};o[s]=i;debug("prevalidated val",o,i,t[s]);if(!validate(o,s,i,t[s],n)){exports.invalidHandler?exports.invalidHandler(s,i,t[s],e):exports.invalidHandler!==!1&&debug("invalid: "+s+"="+i,t[s]);return r}debug("validated val",o,i,t[s]);return o[s]}).filter(function(e){return e!==r});if(!o.length)delete e[s];else if(u){debug(u,e[s],o);e[s]=o}else e[s]=o[0];debug("k=%s val=%j",s,o,e[s])})}function validateString(e,t,n){e[t]=String(n)}function validatePath(e,t,n){e[t]=path.resolve(String(n));return!0}function validateNumber(e,t,n){debug("validate Number %j %j %j",t,n,isNaN(n));if(isNaN(n))return!1;e[t]=+n}function validateDate(e,t,n){debug("validate Date %j %j %j",t,n,Date.parse(n));var r=Date.parse(n);if(isNaN(r))return!1;e[t]=new Date(n)}function validateBoolean(e,t,n){n instanceof Boolean?n=n.valueOf():typeof n=="string"?isNaN(n)?n==="null"||n==="false"?n=!1:n=!0:n=!!+n:n=!!n;e[t]=n}function validateUrl(e,t,n){n=url.parse(String(n));if(!n.host)return!1;e[t]=n.href}function validateStream(e,t,n){if(!(n instanceof Stream))return!1;e[t]=n}function validate(e,t,n,r,i){if(Array.isArray(r)){for(var s=0,o=r.length;s<o;s++){if(r[s]===Array)continue;if(validate(e,t,n,r[s],i))return!0}delete e[t];return!1}if(r===Array)return!0;if(r!==r){debug("Poison NaN",t,n,r);delete e[t];return!1}if(n===r){debug("Explicitly allowed %j",n);e[t]=n;return!0}var u=!1,a=Object.keys(i);for(var s=0,o=a.length;s<o;s++){debug("test type %j %j %j",t,n,a[s]);var f=i[a[s]];if(f&&r===f.type){var l={};u=!1!==f.validate(l,t,n);n=l[t];if(u){e[t]=n;break}}}debug("OK? %j (%j %j %j)",u,t,n,a[s]);u||delete e[t];return u}function parse(e,t,n,r,i){debug("parse",e,t,n);var s=null,o=abbrev(Object.keys(r)),u=abbrev(Object.keys(i));for(var a=0;a<e.length;a++){var f=e[a];debug("arg",f);if(f.match(/^-{2,}$/)){n.push.apply(n,e.slice(a+1));e[a]="--";break}if(f.charAt(0)==="-"){if(f.indexOf("=")!==-1){var l=f.split("=");f=l.shift();l=l.join("=");e.splice.apply(e,[a,1].concat([f,l]))}var c=resolveShort(f,i,u,o);debug("arg=%j shRes=%j",f,c);if(c){debug(f,c);e.splice.apply(e,[a,1].concat(c));if(f!==c[0]){a--;continue}}f=f.replace(/^-+/,"");var h=!1;while(f.toLowerCase().indexOf("no-")===0){h=!h;f=f.substr(3)}o[f]&&(f=o[f]);var p=r[f]===Array||Array.isArray(r[f])&&r[f].indexOf(Array)!==-1,d,v=e[a+1],m=h||r[f]===Boolean||Array.isArray(r[f])&&r[f].indexOf(Boolean)!==-1||v==="false"&&(r[f]===null||Array.isArray(r[f])&&~r[f].indexOf(null));if(m){d=!h;if(v==="true"||v==="false"){d=JSON.parse(v);v=null;h&&(d=!d);a++}if(Array.isArray(r[f])&&v)if(~r[f].indexOf(v)){d=v;a++}else if(v==="null"&&~r[f].indexOf(null)){d=null;a++}else if(!v.match(/^-{2,}[^-]/)&&!isNaN(v)&&~r[f].indexOf(Number)){d=+v;a++}else if(!v.match(/^-[^-]/)&&~r[f].indexOf(String)){d=v;a++}p?(t[f]=t[f]||[]).push(d):t[f]=d;continue}if(v&&v.match(/^-{2,}$/)){v=undefined;a--}d=v===undefined?!0:v;p?(t[f]=t[f]||[]).push(d):t[f]=d;a++;continue}n.push(f)}}function resolveShort(e,t,n,r){e=e.replace(/^-+/,"");if(r[e]&&!t[e])return null;if(n[e])e=n[e];else{var i=t.___singles;if(!i){i=Object.keys(t).filter(function(e){return e.length===1}).reduce(function(e,t){e[t]=!0;return e},{});t.___singles=i}var s=e.split("").filter(function(e){return i[e]});if(s.join("")===e)return s.map(function(e){return t[e]}).reduce(function(e,t){return e.concat(t)},[])}t[e]&&!Array.isArray(t[e])&&(t[e]=t[e].split(/\s+/));return t[e]}var debug=process.env.DEBUG_NOPT||process.env.NOPT_DEBUG?function(){console.error.apply(console,arguments)}:function(){},url=require("url"),path=require("path"),Stream=require("stream").Stream,abbrev=require("abbrev");module.exports=exports=nopt;exports.clean=clean;exports.typeDefs={String:{type:String,validate:validateString},Boolean:{type:Boolean,validate:validateBoolean},url:{type:url,validate:validateUrl},Number:{type:Number,validate:validateNumber},path:{type:path,validate:validatePath},Stream:{type:Stream,validate:validateStream},Date:{type:Date,validate:validateDate}};if(module===require.main){var assert=require("assert"),util=require("util"),shorthands={s:["--loglevel","silent"],d:["--loglevel","info"],dd:["--loglevel","verbose"],ddd:["--loglevel","silly"],noreg:["--no-registry"],reg:["--registry"],"no-reg":["--no-registry"],silent:["--loglevel","silent"],verbose:["--loglevel","verbose"],h:["--usage"],H:["--usage"],"?":["--usage"],help:["--usage"],v:["--version"],f:["--force"],desc:["--description"],"no-desc":["--no-description"],local:["--no-global"],l:["--long"],p:["--parseable"],porcelain:["--parseable"],g:["--global"]},types={aoa:Array,nullstream:[null,Stream],date:Date,str:String,browser:String,cache:path,color:["always",Boolean],depth:Number,description:Boolean,dev:Boolean,editor:path,force:Boolean,global:Boolean,globalconfig:path,group:[String,Number],gzipbin:String,logfd:[Number,Stream],loglevel:["silent","win","error","warn","info","verbose","silly"],"long":Boolean,"node-version":[!1,String],npaturl:url,npat:Boolean,"onload-script":[!1,String],outfd:[Number,Stream],parseable:Boolean,pre:Boolean,prefix:path,proxy:url,"rebuild-bundle":Boolean,registry:url,searchopts:String,searchexclude:[null,String],shell:path,t:[Array,String],tag:String,tar:String,tmp:path,"unsafe-perm":Boolean,usage:Boolean,user:String,username:String,userconfig:path,version:Boolean,viewer:path,_exit:Boolean};[["-v",{version:!0},[]],["---v",{version:!0},[]],["ls -s --no-reg connect -d",{loglevel:"info",registry:null},["ls","connect"]],["ls ---s foo",{loglevel:"silent"},["ls","foo"]],["ls --registry blargle",{},["ls"]],["--no-registry",{registry:null},[]],["--no-color true",{color:!1},[]],["--no-color false",{color:!0},[]],["--no-color",{color:!1},[]],["--color false",{color:!1},[]],["--color --logfd 7",{logfd:7,color:!0},[]],["--color=true",{color:!0},[]],["--logfd=10",{logfd:10},[]],["--tmp=/tmp -tar=gtar",{tmp:"/tmp",tar:"gtar"},[]],["--tmp=tmp -tar=gtar",{tmp:path.resolve(process.cwd(),"tmp"),tar:"gtar"},[]],["--logfd x",{},[]],["a -true -- -no-false",{"true":!0},["a","-no-false"]],["a -no-false",{"false":!1},["a"]],["a -no-no-true",{"true":!0},["a"]],["a -no-no-no-false",{"false":!1},["a"]],["---NO-no-No-no-no-no-nO-no-no-No-no-no-no-no-no-no-no-no-no-no-no-no-NO-NO-no-no-no-no-no-no-no-body-can-do-the-boogaloo-like-I-do",{"body-can-do-the-boogaloo-like-I-do":!1},[]],["we are -no-strangers-to-love --you-know the-rules --and so-do-i ---im-thinking-of=a-full-commitment --no-you-would-get-this-from-any-other-guy --no-gonna-give-you-up -no-gonna-let-you-down=true --no-no-gonna-run-around false --desert-you=false --make-you-cry false --no-tell-a-lie --no-no-and-hurt-you false",{"strangers-to-love":!1,"you-know":"the-rules",and:"so-do-i","you-would-get-this-from-any-other-guy":!1,"gonna-give-you-up":!1,"gonna-let-you-down":!1,"gonna-run-around":!1,"desert-you":!1,"make-you-cry":!1,"tell-a-lie":!1,"and-hurt-you":!1},["we","are"]],["-t one -t two -t three",{t:["one","two","three"]},[]],["-t one -t null -t three four five null",{t:["one","null","three"]},["four","five","null"]],["-t foo",{t:["foo"]},[]],["--no-t",{t:["false"]},[]],["-no-no-t",{t:["true"]},[]],["-aoa one -aoa null -aoa 100",{aoa:["one",null,100]},[]],["-str 100",{str:"100"},[]],["--color always",{color:"always"},[]],["--no-nullstream",{nullstream:null},[]],["--nullstream false",{nullstream:null},[]],["--notadate 2011-01-25",{notadate:"2011-01-25"},[]],["--date 2011-01-25",{date:new Date("2011-01-25")},[]]].forEach(function(e){var t=e[0].split(/\s+/),n=e[1],r=e[2],i=nopt(types,shorthands,t,0),s=i.argv;delete i.argv;console.log(util.inspect(i,!1,2,!0),s.remain);for(var o in n){var u=JSON.stringify(n[o]),a=JSON.stringify(i[o]===undefined?null:i[o]);u&&typeof u=="object"?assert.deepEqual(u,a):assert.equal(u,a)}assert.deepEqual(r,s.remain)})};