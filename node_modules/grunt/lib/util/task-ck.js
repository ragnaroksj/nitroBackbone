/*
 * grunt
 * http://gruntjs.com/
 *
 * Copyright (c) 2014 "Cowboy" Ben Alman
 * Licensed under the MIT license.
 * https://github.com/gruntjs/grunt/blob/master/LICENSE-MIT
 */(function(e){"use strict";function t(){this.current={};this._tasks={};this._queue=[];this._placeholder={placeholder:!0};this._marker={marker:!0};this._options={};this._running=!1;this._success={}}e.Task=t;e.create=function(){return new t};t.prototype._throwIfRunning=function(e){if(this._running||!this._options.error)throw e;this._options.error.call({name:null},e)};t.prototype.registerTask=function(e,t,n){if(n==null){n=t;t=null}var r;if(typeof n!="function"){r=this.parseArgs([n]);n=this.run.bind(this,n);n.alias=!0;t||(t='Alias for "'+r.join('", "')+'" task'+(r.length===1?"":"s")+".")}else t||(t="Custom task.");this._tasks[e]={name:e,info:t,fn:n};return this};t.prototype.isTaskAlias=function(e){return!!this._tasks[e].fn.alias};t.prototype.exists=function(e){return e in this._tasks};t.prototype.renameTask=function(e,t){if(!this._tasks[e])throw new Error('Cannot rename missing "'+e+'" task.');this._tasks[t]=this._tasks[e];this._tasks[t].name=t;delete this._tasks[e];return this};t.prototype.parseArgs=function(e){return Array.isArray(e[0])?e[0]:[].slice.call(e)};t.prototype.splitArgs=function(e){if(!e)return[];e=e.replace(/\\\\/g,"￿").replace(/\\:/g,"￾");return e.split(":").map(function(e){return e.replace(/\uFFFE/g,":").replace(/\uFFFF/g,"\\")})};t.prototype._taskPlusArgs=function(e){var t=this.splitArgs(e),n=t.length,r;do r=this._tasks[t.slice(0,n).join(":")];while(!r&&--n>0);var i=t.slice(n),s={};i.forEach(function(e){s[e]=!0});return{task:r,nameArgs:e,args:i,flags:s}};t.prototype._push=function(e){var t=this._queue.indexOf(this._placeholder);t===-1?this._queue=this._queue.concat(e):[].splice.apply(this._queue,[t,0].concat(e))};t.prototype.run=function(){var e=this.parseArgs(arguments).map(this._taskPlusArgs,this),t=e.filter(function(e){return!e.task});if(t.length>0){this._throwIfRunning(new Error('Task "'+t[0].nameArgs+'" not found.'));return this}this._push(e);return this};t.prototype.mark=function(){this._push(this._marker);return this};t.prototype.runTaskFn=function(e,t,n,r){var i=!1,s=function(t){var i=null;if(t===!1)i=new Error('Task "'+e.nameArgs+'" failed.');else if(t instanceof Error||{}.toString.call(t)==="[object Error]"){i=t;t=!1}else t=!0;this.current={};this._success[e.nameArgs]=t;!t&&this._options.error&&this._options.error.call({name:e.name,nameArgs:e.nameArgs},i);r?process.nextTick(function(){n(i,t)}):n(i,t)}.bind(this);e.async=function(){i=!0;return function(e){setTimeout(function(){s(e)},1)}};this.current=e;try{var o=t.call(e);i||s(o)}catch(u){s(u)}};t.prototype.start=function(e){e||(e={});if(this._running)return!1;var t=function(){var n;do n=this._queue.shift();while(n===this._placeholder||n===this._marker);if(!n){this._running=!1;this._options.done&&this._options.done();return}this._queue.unshift(this._placeholder);var r={nameArgs:n.nameArgs,name:n.task.name,args:n.args,flags:n.flags};this.runTaskFn(r,function(){return n.task.fn.apply(this,this.args)},t,!!e.asyncDone)}.bind(this);this._running=!0;t()};t.prototype.clearQueue=function(e){e||(e={});e.untilMarker?this._queue.splice(0,this._queue.indexOf(this._marker)+1):this._queue=[];return this};t.prototype.requires=function(){this.parseArgs(arguments).forEach(function(e){var t=this._success[e];if(!t)throw new Error('Required task "'+e+'" '+(t===!1?"failed":"must be run first")+".")}.bind(this))};t.prototype.options=function(e){Object.keys(e).forEach(function(t){this._options[t]=e[t]}.bind(this))}})(typeof exports=="object"&&exports||this);