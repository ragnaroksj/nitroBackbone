/*
 * grunt
 * http://gruntjs.com/
 *
 * Copyright (c) 2014 "Cowboy" Ben Alman
 * Licensed under the MIT license.
 * https://github.com/gruntjs/grunt/blob/master/LICENSE-MIT
 */"use strict";var grunt=require("../grunt"),fs=require("fs"),path=require("path"),file=module.exports={};file.glob=require("glob");file.minimatch=require("minimatch");file.findup=require("findup-sync");var YAML=require("js-yaml"),rimraf=require("rimraf"),iconv=require("iconv-lite"),win32=process.platform==="win32",unixifyPath=function(e){return win32?e.replace(/\\/g,"/"):e};file.setBase=function(){var e=path.join.apply(path,arguments);process.chdir(e)};var processPatterns=function(e,t){var n=[];grunt.util._.flatten(e).forEach(function(e){var r=e.indexOf("!")===0;r&&(e=e.slice(1));var i=t(e);r?n=grunt.util._.difference(n,i):n=grunt.util._.union(n,i)});return n};file.match=function(e,t,n){if(grunt.util.kindOf(e)!=="object"){n=t;t=e;e={}}if(t==null||n==null)return[];Array.isArray(t)||(t=[t]);Array.isArray(n)||(n=[n]);return t.length===0||n.length===0?[]:processPatterns(t,function(t){return file.minimatch.match(n,t,e)})};file.isMatch=function(){return file.match.apply(file,arguments).length>0};file.expand=function(){var e=grunt.util.toArray(arguments),t=grunt.util.kindOf(e[0])==="object"?e.shift():{},n=Array.isArray(e[0])?e[0]:e;if(n.length===0)return[];var r=processPatterns(n,function(e){return file.glob.sync(e,t)});t.filter&&(r=r.filter(function(e){e=path.join(t.cwd||"",e);try{return typeof t.filter=="function"?t.filter(e):fs.statSync(e)[t.filter]()}catch(n){return!1}}));return r};var pathSeparatorRe=/[\/\\]/g,extDotRe={first:/(\.[^\/]*)?$/,last:/(\.[^\/\.]*)?$/};file.expandMapping=function(e,t,n){n=grunt.util._.defaults({},n,{extDot:"first",rename:function(e,t){return path.join(e||"",t)}});var r=[],i={};file.expand(n,e).forEach(function(e){var s=e;n.flatten&&(s=path.basename(s));"ext"in n&&(s=s.replace(extDotRe[n.extDot],n.ext));var o=n.rename(t,s,n);n.cwd&&(e=path.join(n.cwd,e));o=o.replace(pathSeparatorRe,"/");e=e.replace(pathSeparatorRe,"/");if(i[o])i[o].src.push(e);else{r.push({src:[e],dest:o});i[o]=r[r.length-1]}});return r};file.mkdir=function(e,t){if(grunt.option("no-write"))return;t==null&&(t=parseInt("0777",8)&~process.umask());e.split(pathSeparatorRe).reduce(function(e,n){e+=n+"/";var r=path.resolve(e);if(!file.exists(r))try{fs.mkdirSync(r,t)}catch(i){throw grunt.util.error('Unable to create directory "'+r+'" (Error code: '+i.code+").",i)}return e},"")};file.recurse=function e(t,n,r){var i=r?path.join(t,r):t;fs.readdirSync(i).forEach(function(s){var o=path.join(i,s);fs.statSync(o).isDirectory()?e(t,n,unixifyPath(path.join(r||"",s||""))):n(unixifyPath(o),t,r,s)})};file.defaultEncoding="utf8";file.preserveBOM=!1;file.read=function(e,t){t||(t={});var n;grunt.verbose.write("Reading "+e+"...");try{n=fs.readFileSync(String(e));if(t.encoding!==null){n=iconv.decode(n,t.encoding||file.defaultEncoding);!file.preserveBOM&&n.charCodeAt(0)===65279&&(n=n.substring(1))}grunt.verbose.ok();return n}catch(r){grunt.verbose.error();throw grunt.util.error('Unable to read "'+e+'" file (Error code: '+r.code+").",r)}};file.readJSON=function(e,t){var n=file.read(e,t),r;grunt.verbose.write("Parsing "+e+"...");try{r=JSON.parse(n);grunt.verbose.ok();return r}catch(i){grunt.verbose.error();throw grunt.util.error('Unable to parse "'+e+'" file ('+i.message+").",i)}};file.readYAML=function(e,t){var n=file.read(e,t),r;grunt.verbose.write("Parsing "+e+"...");try{r=YAML.load(n);grunt.verbose.ok();return r}catch(i){grunt.verbose.error();throw grunt.util.error('Unable to parse "'+e+'" file ('+i.problem+").",i)}};file.write=function(e,t,n){n||(n={});var r=grunt.option("no-write");grunt.verbose.write((r?"Not actually writing ":"Writing ")+e+"...");file.mkdir(path.dirname(e));try{Buffer.isBuffer(t)||(t=iconv.encode(t,n.encoding||file.defaultEncoding));r||fs.writeFileSync(e,t);grunt.verbose.ok();return!0}catch(i){grunt.verbose.error();throw grunt.util.error('Unable to write "'+e+'" file (Error code: '+i.code+").",i)}};file.copy=function(e,t,n){n||(n={});var r=n.process&&n.noProcess!==!0&&(!n.noProcess||!file.isMatch(n.noProcess,e)),i=r?n:{encoding:null},s=file.read(e,i);if(r){grunt.verbose.write("Processing source...");try{s=n.process(s,e);grunt.verbose.ok()}catch(o){grunt.verbose.error();throw grunt.util.error('Error while processing "'+e+'" file.',o)}}s===!1?grunt.verbose.writeln("Write aborted."):file.write(t,s,i)};file.delete=function(e,t){e=String(e);var n=grunt.option("no-write");t||(t={force:grunt.option("force")||!1});grunt.verbose.write((n?"Not actually deleting ":"Deleting ")+e+"...");if(!file.exists(e)){grunt.verbose.error();grunt.log.warn("Cannot delete nonexistent file.");return!1}if(!t.force){if(file.isPathCwd(e)){grunt.verbose.error();grunt.fail.warn("Cannot delete the current working directory.");return!1}if(!file.isPathInCwd(e)){grunt.verbose.error();grunt.fail.warn("Cannot delete files outside the current working directory.");return!1}}try{n||rimraf.sync(e);grunt.verbose.ok();return!0}catch(r){grunt.verbose.error();throw grunt.util.error('Unable to delete "'+e+'" file ('+r.message+").",r)}};file.exists=function(){var e=path.join.apply(path,arguments);return fs.existsSync(e)};file.isLink=function(){var e=path.join.apply(path,arguments);return file.exists(e)&&fs.lstatSync(e).isSymbolicLink()};file.isDir=function(){var e=path.join.apply(path,arguments);return file.exists(e)&&fs.statSync(e).isDirectory()};file.isFile=function(){var e=path.join.apply(path,arguments);return file.exists(e)&&fs.statSync(e).isFile()};file.isPathAbsolute=function(){var e=path.join.apply(path,arguments);return path.resolve(e)===e.replace(/[\/\\]+$/,"")};file.arePathsEquivalent=function(e){e=path.resolve(e);for(var t=1;t<arguments.length;t++)if(e!==path.resolve(arguments[t]))return!1;return!0};file.doesPathContain=function(e){e=path.resolve(e);var t;for(var n=1;n<arguments.length;n++){t=path.relative(path.resolve(arguments[n]),e);if(t===""||/\w+/.test(t))return!1}return!0};file.isPathCwd=function(){var e=path.join.apply(path,arguments);try{return file.arePathsEquivalent(fs.realpathSync(process.cwd()),fs.realpathSync(e))}catch(t){return!1}};file.isPathInCwd=function(){var e=path.join.apply(path,arguments);try{return file.doesPathContain(fs.realpathSync(process.cwd()),fs.realpathSync(e))}catch(t){return!1}};